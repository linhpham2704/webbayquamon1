<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
          crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="../css/main.css" rel="stylesheet">

    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="  crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <title>Trắc nghiệm</title>
</head>
<body>
<header>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container-fluid">
            <a class="navbar-brand" href="home.html">
                <img src="../images/logo.png" width="50" height="50" style="border-radius: 50%">
            </a>
            <button
                    class="navbar-toggler"
                    type="button"
                    data-mdb-toggle="collapse"
                    data-mdb-target="#navbarExample01"
                    aria-controls="navbarExample01"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
            >
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarExample01">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item active">
                        <a class="nav-link" aria-current="page" href="home.html" style="font-size: 20px">Home</a>
                    </li>
                    <div class="collapse navbar-collapse" id="navbarNavDarkDropdown">
                        <ul class="navbar-nav">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 20px">
                                    Học tập
                                </a>
                                <ul class="dropdown-menu dropdown-menu" aria-labelledby="navbarDarkDropdownMenuLink">
                                    <li><a class="dropdown-item" href="tailieu.html">Tài liệu</a></li>
                                    <li><a class="dropdown-item" href="tracnghiem.html">Trắc nghiệm</a></li>
                                    <li><a class="dropdown-item" href="donggop.html">Đóng góp tài liệu</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <li class="nav-item">
                        <a class="nav-link" href="aboutus.html" style="font-size: 20px">Về chúng tôi</a>
                    </li>
                </ul>
                <form class="d-flex" method="get" action="tracnghiem.html">
                    <input class="form-control" type="search" name="text" placeholder="Search" aria-label="Search">
                </form>
                <button  id="login" type="button" class="btn btn-outline-secondary ms-4 d-none" data-bs-toggle="modal" data-bs-target="#modal-login">Login</button>
                <div id="login-spinner" class="spinner-border text-light ms-3" role="status"></div>
                <div class="dropdown" style="right: 0">
                    <a href="#user-signed-in"><img id="avatar"  src="../images/user.svg" data-bs-toggle="dropdown" width="38x" height="38x"
                                                   class="user avatar rounded-circle ms-3 d-none dropdown-toggle"></a>
                    <ul class="dropdown-menu dropdown-menu-center text-small" aria-labelledby="dropdownUser1" style="right: 0">

                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modal-login">Profile</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#" onclick="firebase.auth().signOut();">Sign out</a></li>
                    </ul>
                </div>
                <div class="modal fade d-block1" id="modal-login" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg" >
                        <div class="modal-content shadow">
                            <div class="modal-header">
                                <h3 class="modal-title">Login</h3>
                                <h3 class="modal-title-signed d-none">Profile</h3>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="" class="guest">
                                    <div class="container-1">
                                        <form action="/">
                                            <div id="firebaseui-auth-container"></div>

                                            <div class="d-flex justify-content-center pt-3" style="font-size: 30px; color: gray">
                                                OR
                                            </div>

                                            <div class="pt-3">
                                                <input class="input" type="text" name="username" placeholder="Username" required>
                                                <input class="input" type="password" name="password" placeholder="Password" required>
                                                <input class="input" type="submit" value="Login">
                                            </div>

                                        </form>
                                    </div>
                                    <div class="login-icon"></div>
                                </div>
                                <div id="user-signed-in" class="d-none d-flex user">
                                    <div class="flex-grow-1 d-flex justify-content-center">
                                        <img  src="../images/user.svg" width="110px" height="110px" class="avatar rounded-circle">
                                    </div>
                                    <div class="flex-grow-1  d-flex flex-column align-self-center me-4">
                                        <div id="name" class="align-self-center text-primary fs-5">Name</div>
                                        <div id="email" class="align-self-center ">Email</div>
                                        <div id="phone">Phone</div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer d-none user">
                                <button id="sign-out" type="button" class="btn btn-danger" onclick="firebase.auth().signOut();">Sign out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <nav id="myHeader" class="navbar navbar-expand-md navbar-dark bg">
        <div class="container container-fluid">
            <div style="font-size: 30px; color: white;" id="subjectName"></div>
            <div class="d-flex justify-content-end" style="font-size: 20px; color: white;">00:00</div>
        </div>
    </nav>
</header>

<main>
    <div class="main2">
        <form name="myform" id='testform' method="post" action="http://localhost:8080/api/objectivetest/check">
            <div id="Title1" class="content-nb">
            </div>
        </form>
    </div>

    <div class="card shadow-0 border mt-5" style="background-color: #f0f2f5;">
        <div class="container mb-5 mt-5">
            <div class="card1">
                <div class="row">
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-md-12">
                                <h5 class="mb-4" id="comment_num"></h5>
                                <div class="form-outline mb-4">
                                    <form class="d-flex user d-none" id='comment_form' onsubmit="comment_submit(event)">
                                        <input id="objectiveTest_id" type="hidden" value="" name="objectiveTest_id"/>
                                        <input id="username" type="hidden" value="" name="name"/>
                                        <input id="useremail" type="hidden" value="" name="email"/>
                                        <input id="userphoto_url" type="hidden" value="" name="photoURL"/>
                                        <div class="flex-grow-1"><input type="text" class="form-control" name="text" placeholder="Comment"/></div>
                                        <div class="ps-2">
                                            <button class="btn btn-outline-success" type="submit">Send</button>
                                        </div>
                                    </form>
                                    <div class="text-center guest">You must be <a href="#" data-bs-toggle="modal" data-bs-target="#modal-login">logged in</a> to post a comment.</div>
                                </div>
                                <div id="comment"></div>
<!--                                <div class="media mt-4"> <img class="mr-3 rounded-circle" alt="Bootstrap Media Preview" src="https://i.imgur.com/xELPaag.jpg" />-->
<!--                                    <div class="media-body">-->
<!--                                        <div class="row">-->
<!--                                            <div class="col-8 d-flex">-->
<!--                                                <h5>Shad f</h5> <span>- 2 hours ago</span>-->
<!--                                            </div>-->
<!--                                            <div class="col-4">-->
<!--                                                <div class="pull-right reply"> <a href="#"><span><i class="fa fa-reply"></i> reply</span></a> </div>-->
<!--                                            </div>-->
<!--                                        </div> The standard chunk of Lorem Ipsum used since the 1500s is reproduced below for those interested. Sections 1.10.32 and 1.10.33. <div class="media mt-4"> <a class="pr-3" href="#"><img class="rounded-circle" alt="Bootstrap Media Another Preview" src="https://i.imgur.com/nUNhspp.jpg" /></a>-->
<!--                                        <div class="media-body">-->
<!--                                            <div class="row">-->
<!--                                                <div class="col-12 d-flex">-->
<!--                                                    <h5>Andy flowe</h5> <span>- 5 hours ago</span>-->
<!--                                                </div>-->
<!--                                            </div> Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin commodo. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis.-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                        <div class="media mt-3"> <a class="pr-3" href="#"><img class="rounded-circle" alt="Bootstrap Media Another Preview" src="https://i.imgur.com/HjKTNkG.jpg" /></a>-->
<!--                                            <div class="media-body">-->
<!--                                                <div class="row">-->
<!--                                                    <div class="col-12 d-flex">-->
<!--                                                        <h5>Simp f</h5> <span>- 5 hours ago</span>-->
<!--                                                    </div>-->
<!--                                                </div> a Latin professor at Hampden-Sydney College in Virginia, looked up one of the more obscure Latin words, consectetur-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                        <div class="media mt-3"> <a class="pr-3" href="#"><img class="rounded-circle" alt="Bootstrap Media Another Preview" src="https://i.imgur.com/nAcoHRf.jpg" /></a>-->
<!--                                            <div class="media-body">-->
<!--                                                <div class="row">-->
<!--                                                    <div class="col-12 d-flex">-->
<!--                                                        <h5>John Smith</h5> <span>- 4 hours ago</span>-->
<!--                                                    </div>-->
<!--                                                </div> the majority have suffered alteration in some form, by injected humour, or randomised words.-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-app.js";
        const app = initializeApp(firebaseConfig);
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-auth.js";
        const auth = getAuth();
        console.log(auth)
        auth.onAuthStateChanged(function(user) {
            if (user) {
                $("#username").attr("value",user.displayName);
                $("#useremail").attr("value",user.email);
                $("#userphoto_url").attr("value",user.photoURL);
            } else {
                console.log("No log in")
            }
        });
    </script>
    <script>
        window.onscroll = function() {myFunction()};

        var header = document.getElementById("myHeader");
        var sticky = header.offsetTop;
        const urlSearchParams = new URLSearchParams(window.location.search);
        const params = Object.fromEntries(urlSearchParams.entries());
        console.log(params)
        let testresult = sessionStorage.getItem("testresult")
        console.log(testresult)

        function myFunction() {
            if (window.pageYOffset > sticky) {
                header.classList.add("sticky");
            } else {
                header.classList.remove("sticky");
            }
        }

        function comment_func() {
            $.ajax({
                url: "http://localhost:8080/api/comment?id=" + params.objectiveTestId,
                type: "GET"
            }).done(function (data) {
                let comments = data;
                console.log("list.length = " + comments.length)
                console.log(comments)
                $("#comment_num").empty()
                $("#comment_num").append("Comments (<span text=\""+comments.length+"\">"+comments.length+"</span>)")
                $("#objectiveTest_id").attr("value",params.objectiveTestId);
                $("#comment").empty();
                var photoURL="";
                jQuery.each(comments, function (i, val) {
                    if(val.photoURL!=null & val.photoURL!="") photoURL=val.photoURL;
                    else photoURL="https://st3.depositphotos.com/23594922/31822/v/600/depositphotos_318221368-stock-illustration-missing-picture-page-for-website.jpg";
                    if(val.name!=null)
                        $("#comment").append("<div class=\"media\"> <a class=\"pr-3\" href=\"#\"><img class=\"rounded-circle\" alt=\"Bootstrap Media Another Preview\" src='"+photoURL+"' /></a>\n" +
                        "                                    <div class=\"media-body\">\n" +
                        "                                        <div class=\"row\">\n" +
                        "                                            <div class=\"col-8 d-flex\">\n" +
                        "                                                <h5>"+val.name+"</h5>&nbsp-&nbsp<span>"+val.timeAgo+"</span>\n" +
                        "                                            </div>\n" +
                        "                                            <div class=\"col-4\">\n" +
                        "                                                <div class=\"pull-right reply\"> <a href=\"#\"><span><i class=\"fa fa-reply\"></i> reply</span></a> </div>\n" +
                        "                                            </div>\n" +
                        "                                        </div> "+val.text+" <div class=\"media mt-4\">");
                    else $("#comment").append("<div class=\"media\"> <a class=\"pr-3\" href=\"#\"><img class=\"rounded-circle\" alt=\"Bootstrap Media Another Preview\" src='"+photoURL+"' /></a>\n" +
                        "                                    <div class=\"media-body\">\n" +
                        "                                        <div class=\"row\">\n" +
                        "                                            <div class=\"col-8 d-flex\">\n" +
                        "                                                &nbsp-&nbsp<span> "+val.timeAgo+"</span>\n" +
                        "                                            </div>\n" +
                        "                                            <div class=\"col-4\">\n" +
                        "                                                <div class=\"pull-right reply\"> <a href=\"#\"><span><i class=\"fa fa-reply\"></i> reply</span></a> </div>\n" +
                        "                                            </div>\n" +
                        "                                        </div> "+val.text+" <div class=\"media mt-4\">");
                })
            }).fail(function (xhr, status, errorThrown) {
                $("#title").html("Sorry, there was a problem!")
            })
        }

        function comment_submit(event){
            event.preventDefault();

            var form = document.getElementById('comment_form');
            var xhr = new XMLHttpRequest();
            var formData = new FormData(form);
            //open the request
            xhr.open('POST','http://localhost:8080/api/comment/add');
            xhr.setRequestHeader("Content-Type", "application/json");

            //send the form data
            xhr.send(JSON.stringify(Object.fromEntries(formData)));

            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    form.reset(); //reset form after AJAX success or do something else
                    comment_func()
                }
            }
            //Fail the onsubmit to avoid page refresh.
            return false;
        }

        $.ajax({
            "url": "http://localhost:8080/api/objectivetest/check",
            "method": "POST",
            "data": params,
        }).done(function (response) {
            let testresult = response;
            sessionStorage.setItem("testresult", testresult);
            console.log(response)
            $("#Title1").empty()
            $("#Title1").append("<h1>"+testresult.testName+"</h1><h2>Trả bài</h2><br><div style='color: green'><h3>Điểm của bạn là: "+testresult.score+"/"+testresult.totalScore+"</h3></div>")
            var distance=testresult.dotime;
            var minutes = Math.floor((distance / (1000 * 60)));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);
            var dotime = ""
            if(minutes>0) dotime = minutes + " phút";
            if(seconds>0) dotime = dotime + " " + seconds +" giây";
            if(testresult.time>0)
                $("#Title1").append("<div style='color: green'><h3>Thời gian làm bài: "+dotime+"/"+testresult.time+" phút</h3></div>")
            $("#Title1").append("<br>");

            jQuery.each(testresult.formAnswerList, function (i, val) {
                let q=val.question;
                let num = i + 1;
                let answers = q.answers;
                let title = q.title;
                if (/^\d*./.test(q.title))
                    title = q.title.substring(q.title.indexOf(".") + 1).trim();
                if (/^Câu \d*:/.test(val.title))
                    title = q.title.substring(q.title.indexOf(":") + 1).trim();
                $("#Title1").append("<div id='question_" + num + "'><b>"
                    + num + ". " + title+"</b>")
                $("#Title1").append("<input type='hidden' name='" + "qid_" + num + "' value='"+q.id+"'></input>")
                if (q.image != null)
                    $("#Title1").append("<img src='" + q.image + "'></img> <br>")
                jQuery.each(answers, function (a_i, a_val) {
                    $("#Title1").append("<div id='text_answer_" + num + "_"+a_val.answerHead+"'>" + a_val.answer + "<div>")
                })
                if(val.answerHead!='.'){
                    if(val.check) document.getElementById("text_answer_" + num + "_"+val.answerHead).style.color='blue';
                    else document.getElementById("text_answer_" + num + "_"+val.answerHead).style.color='red';
                }
                $("#Title1").append("<div id='result_"+num+"'></div> <div id='solution_"+num+"' style='color: grey'></div> <div id='feedback_"+num+"' style='color: orange'></div> </p> <br> </div>")
                if(val.check){
                    $("#result_"+num).append("Đúng");
                    document.getElementById("result_"+num).style.color='blue';
                }
                else{
                    $("#result_"+num).append("Sai");
                    document.getElementById("result_"+num).style.color='red';
                    if(q.solution!=null)
                        $("#solution_"+num).append("Câu trả lời đúng là: <br>"+q.solution);
                }
                if(q.feedback!=null){
                    $("#feedback_"+num).append("Phản hồi: <br>"+q.feedback);
                }
            })

            let redo="tracnghiem2.html";
            redo=redo+"?sbjid="+params.sbjid;
            redo=redo+"&testName="+params.testName;
            $('#Title1').append("<div class='d-flex justify-content-center align-items-center pt-2'>\n" +
                "                <button class='btn btn-outline-primary' type='button' onclick='window.location.replace(\""+redo+"\")' style='border-radius: 27px;'>Làm lại</button>\n" +
                "            </div>")
            comment_func()
        });
    </script>
</main>

<footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
    <script src="../../js/main.js"></script>
</footer>
</body>
</html>